# ModernCPP Makefile - C++20 with Boost
# μ΄λ³΄μλ„ μ‰½κ² μ‚¬μ©ν•  μ μλ” Make λΉλ“ μ‹μ¤ν…

# ============================================
# μ»΄νμΌλ¬ λ° ν”λκ·Έ μ„¤μ •
# ============================================
# macOSμ—μ„λ” clang++μ΄ λ” μ•μ •μ μ…λ‹λ‹¤
CXX := clang++
CXXFLAGS := -std=c++20 -stdlib=libc++ -Wall -Wextra -O2 -I./include
LDFLAGS := -lboost_system -lboost_thread -lpthread

# Linuxμ—μ„λ” g++μ„ μ‚¬μ©ν•λ ¤λ©΄ μ•„λ μ¤„μ μ£Όμ„μ„ ν•΄μ ν•μ„Έμ”
# CXX := g++

# macOS SDK κ²½λ΅ μλ™ νƒμ§€ λ° C++ ν‘μ¤€ λΌμ΄λΈλ¬λ¦¬ ν—¤λ” κ²½λ΅
MACOS_SDK := $(shell xcrun --show-sdk-path 2>/dev/null)
ifneq ($(MACOS_SDK),)
    CXXFLAGS += -isysroot $(MACOS_SDK)
    # SDK λ‚΄μ C++ ν—¤λ” λ…μ‹μ μΌλ΅ μ¶”κ°€
    CXXFLAGS += -I$(MACOS_SDK)/usr/include/c++/v1
endif

# macOSμ—μ„ Boost κ²½λ΅ (Homebrew μ„¤μΉ κΈ°μ¤€)
# brew install boost ν›„ μ‚¬μ©
BOOST_INCLUDE := $(shell brew --prefix boost 2>/dev/null)/include
BOOST_LIB := $(shell brew --prefix boost 2>/dev/null)/lib

ifneq ($(BOOST_INCLUDE),)
    CXXFLAGS += -I$(BOOST_INCLUDE)
endif
ifneq ($(BOOST_LIB),)
    LDFLAGS += -L$(BOOST_LIB)
endif

# ============================================
# λ””λ ‰ν† λ¦¬ μ„¤μ •
# ============================================
BUILD_DIR := ./build
SRC_DIR := ./src
INCLUDE_DIR := ./include

# ============================================
# μ†μ¤ νμΌ μλ™ νƒμƒ‰
# ============================================
# μ„λ²„ μ†μ¤
SERVER_SOURCES := $(wildcard $(SRC_DIR)/server/*.cpp)
SERVER_OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(SERVER_SOURCES))
SERVER_TARGET := $(BUILD_DIR)/server_app

# ν΄λΌμ΄μ–ΈνΈ μ†μ¤
CLIENT_SOURCES := $(wildcard $(SRC_DIR)/client/*.cpp)
CLIENT_OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(CLIENT_SOURCES))
CLIENT_TARGET := $(BUILD_DIR)/client_app

# κ³µν†µ λΌμ΄λΈλ¬λ¦¬
COMMON_SOURCES := $(wildcard $(SRC_DIR)/common/*.cpp)
COMMON_OBJECTS := $(patsubst $(SRC_DIR)/%.cpp,$(BUILD_DIR)/%.o,$(COMMON_SOURCES))

# μμ  νμΌλ“¤ (κ°κ° λ…λ¦½ μ‹¤ν–‰ νμΌ)
EXAMPLE_SOURCES := $(wildcard $(SRC_DIR)/examples/*.cpp)
EXAMPLE_TARGETS := $(patsubst $(SRC_DIR)/examples/%.cpp,$(BUILD_DIR)/examples/%,$(EXAMPLE_SOURCES))

# ============================================
# κΈ°λ³Έ νƒ€κ²
# ============================================
.PHONY: all clean server client examples help

# κΈ°λ³Έ: λ¨λ“  κ²ƒ λΉλ“
all: server client examples

# μ„λ²„λ§ λΉλ“
server: $(SERVER_TARGET)

# ν΄λΌμ΄μ–ΈνΈλ§ λΉλ“
client: $(CLIENT_TARGET)

# μμ λ“¤λ§ λΉλ“
examples: $(EXAMPLE_TARGETS)

# ============================================
# λΉλ“ κ·μΉ™
# ============================================

# μ„λ²„ μ‹¤ν–‰ νμΌ
$(SERVER_TARGET): $(SERVER_OBJECTS) $(COMMON_OBJECTS) | $(BUILD_DIR)
	@echo "π”¨ μ„λ²„ λΉλ“ μ¤‘..."
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… μ„λ²„ λΉλ“ μ™„λ£: $@"

# ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰ νμΌ
$(CLIENT_TARGET): $(CLIENT_OBJECTS) $(COMMON_OBJECTS) | $(BUILD_DIR)
	@echo "π”¨ ν΄λΌμ΄μ–ΈνΈ λΉλ“ μ¤‘..."
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS)
	@echo "β… ν΄λΌμ΄μ–ΈνΈ λΉλ“ μ™„λ£: $@"

# μμ  μ‹¤ν–‰ νμΌλ“¤
$(BUILD_DIR)/examples/%: $(SRC_DIR)/examples/%.cpp $(COMMON_OBJECTS) | $(BUILD_DIR)/examples
	@echo "π”¨ μμ  λΉλ“ μ¤‘: $*"
	$(CXX) $(CXXFLAGS) -o $@ $< $(COMMON_OBJECTS) $(LDFLAGS)
	@echo "β… μμ  λΉλ“ μ™„λ£: $@"

# μ¤λΈμ νΈ νμΌ μƒμ„± κ·μΉ™
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.cpp | $(BUILD_DIR)
	@mkdir -p $(dir $@)
	@echo "π“¦ μ»΄νμΌ μ¤‘: $<"
	$(CXX) $(CXXFLAGS) -c $< -o $@

# λΉλ“ λ””λ ‰ν† λ¦¬ μƒμ„±
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)/server
	mkdir -p $(BUILD_DIR)/client
	mkdir -p $(BUILD_DIR)/common
	mkdir -p $(BUILD_DIR)/examples

$(BUILD_DIR)/examples:
	mkdir -p $(BUILD_DIR)/examples

# ============================================
# μ‹¤ν–‰ νƒ€κ² (ν…μ¤νΈμ©)
# ============================================
.PHONY: run-server run-client

run-server: server
	@echo "π€ μ„λ²„ μ‹¤ν–‰ μ¤‘..."
	@$(SERVER_TARGET)

run-client: client
	@echo "π€ ν΄λΌμ΄μ–ΈνΈ μ‹¤ν–‰ μ¤‘..."
	@$(CLIENT_TARGET)

# ============================================
# μ²­μ†
# ============================================
clean:
	@echo "π§Ή λΉλ“ νμΌ μ •λ¦¬ μ¤‘..."
	rm -rf $(BUILD_DIR)
	@echo "β… μ •λ¦¬ μ™„λ£"

# ============================================
# λ„μ›€λ§
# ============================================
help:
	@echo "================================================"
	@echo "  ModernCPP Makefile μ‚¬μ©λ²•"
	@echo "================================================"
	@echo ""
	@echo "π“ μ£Όμ” λ…λ Ήμ–΄:"
	@echo "  make              - λ¨λ“  κ²ƒ λΉλ“ (μ„λ²„ + ν΄λΌμ΄μ–ΈνΈ + μμ )"
	@echo "  make all          - μ„μ™€ λ™μΌ"
	@echo "  make server       - μ„λ²„λ§ λΉλ“"
	@echo "  make client       - ν΄λΌμ΄μ–ΈνΈλ§ λΉλ“"
	@echo "  make examples     - μμ λ“¤λ§ λΉλ“"
	@echo "  make clean        - λΉλ“ νμΌ λ¨λ‘ μ‚­μ "
	@echo ""
	@echo "π€ μ‹¤ν–‰ λ…λ Ήμ–΄:"
	@echo "  make run-server   - μ„λ²„ λΉλ“ ν›„ μ‹¤ν–‰"
	@echo "  make run-client   - ν΄λΌμ΄μ–ΈνΈ λΉλ“ ν›„ μ‹¤ν–‰"
	@echo ""
	@echo "π“ μƒ νμΌ μ¶”κ°€ λ°©λ²•:"
	@echo "  - src/server/     μ— μ„λ²„ μ½”λ“ μ¶”κ°€"
	@echo "  - src/client/     μ— ν΄λΌμ΄μ–ΈνΈ μ½”λ“ μ¶”κ°€"
	@echo "  - src/common/     μ— κ³µν†µ μ ν‹Έλ¦¬ν‹° μ¶”κ°€"
	@echo "  - src/examples/   μ— ν•™μµ μμ  μ¶”κ°€ (μλ™μΌλ΅ κ°λ³„ λΉλ“λ¨)"
	@echo ""
	@echo "π”§ μƒ λΌμ΄λΈλ¬λ¦¬ μ¶”κ°€ λ°©λ²•:"
	@echo "  - LDFLAGSμ— -lλΌμ΄λΈλ¬λ¦¬λ… μ¶”κ°€"
	@echo "  - μ: LDFLAGS += -lboost_filesystem"
	@echo ""
	@echo "================================================"
